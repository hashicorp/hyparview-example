#!/bin/bash
set -e

required="DOMAIN BOOTSTRAP PUBLIC STAT_UDP"

for e in $required; do
    [ -z "${!e}" ] && {
	echo "usage: $required $0" 1>&2
	exit 2
    }
done

cat <<EOF | ssh -T -o 'StrictHostKeyChecking=accept-new' "$1" 'sh -s'
mkdir -p hveg hveg/cert hveg/env

[ -x /usr/local/bin/consul ] && exit 0
wget -q https://releases.hashicorp.com/consul/1.7.0/consul_1.7.0_linux_amd64.zip
unzip consul_1.7.0_linux_amd64.zip
sudo mv consul /usr/local/bin
EOF

for e in $required HTTP_UI LO HI; do
    echo "${!e}" | ssh -T "$1" "cat >hveg/env/$e"
done

rsync -pr bin/ "$1:hveg/bin/"
rsync -p GNUmakefile "$1:hveg"
rsync -p "cert/$DOMAIN-agent-ca.pem" "$1:hveg/cert"
